<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FitTrack — Login</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <!-- Your styles -->
  <link rel="stylesheet" href="static/css/style.css" />
</head>
<body class="bg-light">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">FitTrack</a>
    </div>
  </nav>

  <!-- Login Card -->
  <main class="container my-5" style="max-width:540px;">
    <div class="card shadow-sm">
      <div class="card-body">
        <h3 class="card-title mb-3">Login to FitTrack</h3>

        <form id="login-form" method="post" novalidate>
          <div class="mb-3">
            <label for="usernameOrEmail" class="form-label">Username or Email</label>
            <input type="text" id="usernameOrEmail" name="username" class="form-control" required aria-describedby="userHelp">
            <div id="userHelp" class="form-text">Use your username or email to sign in.</div>
          </div>

          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" id="password" name="password" class="form-control" required minlength="6">
          </div>

          <div id="login-feedback" role="status" aria-live="polite"></div>

          <div class="d-grid gap-2 mt-3">
            <button type="submit" class="btn btn-primary">Sign in</button>
          </div>
        </form>

        <p class="mt-3 mb-0">Don't have an account? <a href="register.html">Register</a></p>
      </div>
    </div>
  </main>

  <footer class="text-center py-4 text-muted">
    &copy; 2025 FitTrack
  </footer>

  <!-- Bootstrap + script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="static/css/utilities.css">
  <link rel="stylesheet" href="static/css/style.css">


  <!-- Client login script: tries server API first, falls back to localStorage demo -->
  <script>
  (function () {
    const form = document.getElementById('login-form');
    const feedback = document.getElementById('login-feedback');

    function show(msg, ok=true) {
      feedback.innerHTML = '<div class="mt-2 ' + (ok ? 'text-success' : 'text-danger') + '">' + msg + '</div>';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('usernameOrEmail').value.trim();
      const password = document.getElementById('password').value;

      if (!username || !password) {
        show('Please fill both fields.', false);
        return;
      }

      // Try server endpoint first (Flask app.py has /login)
      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ username, password }),
          credentials: 'same-origin'
        });

        // If using Flask render flow, a redirect will happen — but if API style used, check status
        if (res.redirected) {
          // server handled redirect (typical Flask)
          window.location.href = res.url;
          return;
        }

        if (res.ok) {
          // If server returned 200 and JSON, try parse
          const json = await res.json().catch(()=>null);
          if (json && json.message) show(json.message, true);
          // redirect to dashboard
          setTimeout(()=> window.location.href = '/dashboard', 400);
          return;
        }

        // fall through to local fallback
      } catch (err) {
        // Server not available — continue to fallback below
        console.warn('Login API unreachable, using demo fallback');
      }

      // Local fallback (demo): check localStorage users
      const users = JSON.parse(localStorage.getItem('fittrack_users') || '[]');
      // match by username OR email
      const found = users.find(u => (u.username === username || u.email === username) && (u.password === password || atob(u.password||'') === password));
      if (!found) {
        show('Invalid credentials (demo).', false);
        return;
      }

      // create a session object
      const session = { username: found.username, email: found.email, role: found.role || 'user', loggedInAt: new Date().toISOString() };
      localStorage.setItem('fittrack_session', JSON.stringify(session));
      show('Login successful (demo). Redirecting...', true);
      setTimeout(()=> window.location.href = (found.role === 'admin' ? 'admin.html' : 'dashboard.html'), 600);
    });
  })();



  </script>
</body>
</html>

