{% extends 'base.html' %}
{% set nav_variant = 'app' %}
{% set app_area = 'admin' %}

{% block title %}Admin Panel | FitTrack{% endblock %}
{% block body_class %}bg-light ft-admin{% endblock %}
{% block main_class %}admin-main{% endblock %}

{% block page_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css', v='2026-02-20-20') }}">
{% endblock %}

{% block content %}
  <header id="admin-overview" class="container admin-shell my-4">
    <div class="admin-overview-panel">
      <div class="admin-overview-content">
        <h1 class="h3 mb-1">Admin Dashboard</h1>
        <p class="text-muted mb-0">Monitor users, workouts, and account lifecycle actions.</p>
      </div>
      <div class="admin-hero-metrics admin-overview-ghost" aria-hidden="true">
        <div class="admin-hero-metric"><span>&nbsp;</span><strong>&nbsp;</strong></div>
        <div class="admin-hero-metric"><span>&nbsp;</span><strong>&nbsp;</strong></div>
        <div class="admin-hero-metric"><span>&nbsp;</span><strong>&nbsp;</strong></div>
      </div>
    </div>
  </header>

  <section class="container admin-shell admin-hero mb-4" aria-label="Admin command center">
    <article class="admin-hero-shell">
      <div class="admin-hero-content">
        <p class="admin-hero-kicker mb-2">FitTrack Control Center</p>
        <h2 class="admin-hero-title mb-2">Operate with precision and full visibility.</h2>
        <p class="admin-hero-sub mb-0">Track user lifecycle changes in real time, spot trends quickly, and handle moderation actions with reliable safeguards.</p>
      </div>
      <div class="admin-hero-metrics">
        <div class="admin-hero-metric">
          <span>Total active users</span>
          <strong id="adminHeroUsers">{{ total_users }}</strong>
        </div>
        <div class="admin-hero-metric">
          <span>Total workouts</span>
          <strong id="adminHeroWorkouts">{{ total_workouts }}</strong>
        </div>
        <div class="admin-hero-metric">
          <span>Avg calories</span>
          <strong id="adminHeroAvgCalories">{{ avg_calories }}</strong>
        </div>
      </div>
    </article>
  </section>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <section class="container admin-shell mb-3" aria-label="System messages">
        {% for category, message in messages %}
          {% set c = category %}
          {% if c not in ['primary','secondary','success','danger','warning','info','light','dark'] %}
            {% set c = 'info' %}
          {% endif %}
          <div class="alert alert-{{ c }} mb-2" role="alert">{{ message }}</div>
        {% endfor %}
      </section>
    {% endif %}
  {% endwith %}

  <section class="container admin-shell my-4 admin-snapshot" aria-labelledby="admin-snapshot-title">
    <article class="admin-snapshot-card shadow-sm">
      <div class="admin-snapshot-head">
        <h2 id="admin-snapshot-title" class="h5 mb-0">Todayâ€™s Snapshot (All Users)</h2>
        <span class="admin-live-pill"><span class="admin-live-dot"></span>Live</span>
      </div>
      <p class="admin-snapshot-date mb-0">{{ today_snapshot.date_iso }}</p>
      <div class="admin-snapshot-grid mt-3">
        <div class="snapshot-kpi">
          <span class="snapshot-label">Active users today</span>
          <strong id="adminSnapActiveUsers">{{ today_snapshot.active_users }}</strong>
        </div>
        <div class="snapshot-kpi">
          <span class="snapshot-label">Workouts today</span>
          <strong id="adminSnapWorkouts">{{ today_snapshot.workouts }}</strong>
        </div>
        <div class="snapshot-kpi">
          <span class="snapshot-label">Calories today</span>
          <strong><span id="adminSnapCalories">{{ today_snapshot.calories }}</span> kcal</strong>
        </div>
        <div class="snapshot-kpi">
          <span class="snapshot-label">Avg calories/workout</span>
          <strong><span id="adminSnapAvgCalories">{{ today_snapshot.avg_calories }}</span> kcal</strong>
        </div>
      </div>
    </article>
  </section>

  <section class="container admin-shell my-4 admin-controls" aria-labelledby="admin-controls-title">
    <div class="admin-controls-card">
      <h2 id="admin-controls-title" class="h5 mb-3">Admin Controls</h2>
      <div class="row g-3 align-items-end">
        <div class="col-12 col-lg-4">
          <label for="adminSearch" class="form-label mb-1">Search users</label>
          <input type="search" id="adminSearch" class="form-control" placeholder="Username, email, or activity">
        </div>
        <div class="col-6 col-lg-3">
          <label for="adminStatusFilter" class="form-label mb-1">Show</label>
          <select id="adminStatusFilter" class="form-select">
            <option value="all">All users</option>
            <option value="active">Active only</option>
            <option value="archived">Archived only</option>
          </select>
        </div>
        <div class="col-6 col-lg-3">
          <label for="adminSort" class="form-label mb-1">Sort by</label>
          <select id="adminSort" class="form-select">
            <option value="username_asc">Username (A-Z)</option>
            <option value="username_desc">Username (Z-A)</option>
            <option value="active_desc">Active workouts (high-low)</option>
            <option value="avg_cal_desc">Avg calories (high-low)</option>
            <option value="archived_desc">Archived workouts (high-low)</option>
          </select>
        </div>
        <div class="col-12 col-lg-2 d-grid d-lg-flex gap-2">
          <button class="btn btn-dark flex-fill" id="adminRefreshBtn" type="button">
            <i class="fa-solid fa-rotate"></i> Refresh
          </button>
          <button class="btn btn-outline-secondary flex-fill" id="adminResetBtn" type="button">
            Reset
          </button>
        </div>
      </div>
      <div class="admin-controls-meta mt-3">
        <span id="adminResultSummary">Showing all users</span>
        <span id="adminLastSync">Last sync: --</span>
      </div>
    </div>
  </section>

  <section class="container admin-shell my-5 active-users-section" id="activeUsersSection" aria-labelledby="active-users-title">
    <h2 id="active-users-title" class="h4 mb-3">
      <i class="fa-solid fa-users section-meta-icon meta-users"></i>
      Active Users
      <span id="activeUserCountBadge" class="badge text-bg-primary ms-1">{{ user_stats|length }}</span>
    </h2>
    <div class="table-responsive">
      <table class="table table-hover shadow-sm bg-white rounded admin-table admin-table-active">
        <caption class="visually-hidden">List of active users with workout metrics and admin actions</caption>
        <thead class="table-dark">
          <tr>
            <th>Avatar</th>
            <th>Username</th>
            <th>Email</th>
            <th>Active Workouts</th>
            <th>Archived Workouts</th>
            <th>Avg Cal</th>
            <th>Avg Dur</th>
            <th>Frequent Activity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          {% for item in user_stats %}
            <tr class="align-middle">
              <td data-label="Avatar">
                <img src="{{ item.avatar_url or url_for('static', filename='images/FitTrack.jpg') }}" class="avatar-thumb" alt="Avatar">
              </td>
              <td data-label="Username">{{ item.user.username }}</td>
              <td data-label="Email">{{ item.user.email }}</td>
              <td data-label="Active Workouts">{{ item.active_count }}</td>
              <td data-label="Archived Workouts">{{ item.archived_count }}</td>
              <td data-label="Avg Cal">{{ item.avg_cal }}</td>
              <td data-label="Avg Dur">{{ item.avg_dur }}</td>
              <td data-label="Frequent Activity">{{ item.freq_activity }}</td>
              <td data-label="Actions">
                <button class="btn btn-sm btn-outline-primary btn-view" data-user-id="{{ item.user.id }}" title="View">
                  <i class="fa-solid fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning btn-archive" data-user-id="{{ item.user.id }}" title="Archive">
                  <i class="fa-solid fa-box-archive"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger btn-delete" data-user-id="{{ item.user.id }}" title="Delete">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted">No active users</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="container admin-shell my-5 archived-users-section" id="archivedUsersSection" aria-labelledby="archived-users-title">
    <h2 id="archived-users-title" class="h4 mb-3">
      <i class="fa-solid fa-box-archive section-meta-icon meta-archive"></i>
      Archived Users
      <span id="archivedUserCountBadge" class="badge text-bg-secondary ms-1">{{ archived_users|length }}</span>
    </h2>
    <div class="table-responsive">
      <table class="table table-hover shadow-sm bg-white rounded admin-table admin-table-archived">
        <caption class="visually-hidden">List of archived users with preview, restore, and delete actions</caption>
        <thead class="table-dark">
          <tr>
            <th>Avatar</th>
            <th>Username</th>
            <th>Email</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="archivedUsersTableBody">
          {% for u in archived_users %}
            <tr class="align-middle">
              <td data-label="Avatar">
                <img src="{{ u.avatar_url or url_for('static', filename='images/FitTrack.jpg') }}" class="avatar-thumb" alt="Avatar">
              </td>
              <td data-label="Username">{{ u.username }}</td>
              <td data-label="Email">{{ u.email }}</td>
              <td data-label="Actions">
                <button class="btn btn-sm btn-outline-primary btn-view" data-user-id="{{ u.id }}" title="View">
                  <i class="fa-solid fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-success btn-restore-user" data-user-id="{{ u.id }}" title="Restore">
                  <i class="fa-solid fa-rotate-left"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger btn-delete" data-user-id="{{ u.id }}" title="Delete">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="4" class="text-center text-muted">No archived users</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <div id="adminLiveRegion" class="visually-hidden" aria-live="polite"></div>
  <div class="toast-container position-fixed top-0 end-0 p-3 admin-toast-container" id="adminToastContainer"></div>

  <div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title h5 mb-0">User Details: <span id="modalUsername"></span></h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="text-center mb-3">
            <img id="modalAvatar" src="" class="avatar-modal shadow-sm" alt="Avatar">
            <p id="modalEmail" class="mt-2"></p>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Activity</th>
                  <th>Duration</th>
                  <th>Calories</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="modalTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block page_scripts %}
  <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}
